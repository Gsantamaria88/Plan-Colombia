<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan de Viaje ‚Äî Presupuesto & Itinerario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#0b1020;--muted:#5b6476;--soft:#334155;--border:#e5e7eb;--row:#f8fafc;
      --max:1040px;--shadow:0 8px 24px rgba(2,6,23,.08);
      --cat:110px;--eur:64px;--cop:14ch;--act:40px;--detMin:260px;--detMax:65ch;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif}
    .container{width:min(100%,var(--max));margin:auto;padding:12px}
    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    h1{margin:0 0 8px;font-size:20px}
    h2{margin:0 0 8px;font-size:18px;color:var(--soft)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,select,button{font:inherit}
    input[type="text"],input[type="number"],select{background:#eef2ff20;border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    button{background:#f1f5f9;border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button.primary{background:linear-gradient(135deg,#22c55e,#06b6d4);color:#fff;border:none;font-weight:700}

    .table-wrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;table-layout:fixed}
    col.cat{width:var(--cat)} col.det{width:clamp(var(--detMin),50%,var(--detMax))} col.eur{width:var(--eur)} col.cop{width:var(--cop)} col.act{width:var(--act)}
    thead th{font-size:12px;color:var(--muted);border-bottom:1px solid var(--border);text-align:left;padding:6px 8px}
    tbody tr{background:var(--row);border:1px solid var(--border)}
    td{padding:6px 8px}
    .right{text-align:right}
    .eur-input{width:56px;max-width:56px;text-align:right}
    td.cop{white-space:nowrap}
    @media (max-width:600px){ td.cop{font-size:.88rem} .eur-input{width:50px;max-width:50px} }

    canvas{width:100% !important;height:auto !important;background:var(--row);border:1px solid var(--border);border-radius:12px;padding:6px}

    /* Modales */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);padding:16px;z-index:50}
    .box{background:#fff;border:1px solid var(--border);border-radius:16px;max-width:520px;width:100%;padding:16px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Plan de Viaje ‚Äî Presupuesto & Itinerario</h1>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>Gr√°ficos (gastos en ‚Ç¨ por categor√≠a)</h2>
        <div class="row">
          <label for="fx">Tipo de cambio EUR‚ÜíCOP</label>
          <input id="fx" type="number" step="0.01" style="width:120px" />
          <button class="primary" onclick="saveFX()">Actualizar</button>
        </div>
      </div>
      <canvas id="barChart"></canvas>
      <div style="height:8px"></div>
      <canvas id="pieChart"></canvas>
      <p style="font-size:12px;color:#5b6476;margin:8px 0 0">Los gr√°ficos usan importes en euros. Las tablas muestran ‚Ç¨ y COP.</p>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>Presupuesto detallado</h2>
        <div class="row">
          <select id="filterCat" onchange="applyFilter()"><option value="">Todas</option></select>
          <input id="filterText" type="text" placeholder="Filtrar por texto‚Ä¶" oninput="applyFilter()" />
          <button class="primary" onclick="openAddModal()">+ A√±adir</button>
          <button onclick="resetData()">Restablecer</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <colgroup>
            <col class="cat"><col class="det"><col class="eur"><col class="cop"><col class="act">
          </colgroup>
          <thead><tr><th>Cat</th><th>Detalle (m√°x 65c)</th><th class="right">‚Ç¨</th><th class="right">COP</th><th></th></tr></thead>
          <tbody id="tbody-detalle"></tbody>
          <tfoot><tr><td></td><td class="right">TOTAL</td><td class="right" id="total-eur">0</td><td class="right" id="total-cop">0</td><td></td></tr></tfoot>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>Itinerario (costos por d√≠a)</h2>
        <div class="row">
          <input id="filterIt" type="text" placeholder="Filtrar por lugar/actividad‚Ä¶" oninput="applyFilter()" />
          <button class="primary" onclick="openAddItModal()">+ A√±adir d√≠a</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <colgroup>
            <col style="width:110px"><col style="width:70px"><col class="cat"><col class="det"><col class="eur"><col class="cop"><col class="act">
          </colgroup>
          <thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th><th>Actividad</th><th class="right">Costo ‚Ç¨</th><th class="right">Costo COP</th><th></th></tr></thead>
          <tbody id="tbody-it"></tbody>
          <tfoot><tr><td></td><td></td><td></td><td class="right">TOTAL</td><td class="right" id="tot-it-eur">0</td><td class="right" id="tot-it-cop">0</td><td></td></tr></tfoot>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Calendario (lista)</h2>
      <div id="calendarList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px"></div>
    </section>
  </div>

  <!-- Modal presupuesto -->
  <div id="modalAdd" class="modal" aria-hidden="true">
    <div class="box">
      <h3>Agregar √≠tem al presupuesto</h3>
      <div class="row"><label>Categoria</label><select id="mCat"></select></div>
      <div class="row"><label>Detalle</label><input id="mDet" type="text" placeholder="Descripci√≥n"/></div>
      <div class="row"><label>Euros (‚Ç¨)</label><input id="mEur" type="number" step="0.01" value="0"/></div>
      <div class="actions"><button onclick="closeAddModal()">Cancelar</button><button class="primary" onclick="confirmAdd()">A√±adir</button></div>
    </div>
  </div>

  <!-- Modal itinerario -->
  <div id="modalAddIt" class="modal" aria-hidden="true">
    <div class="box">
      <h3>Agregar d√≠a al itinerario</h3>
      <div class="row"><label>Fecha</label><input id="miFecha" type="text" placeholder="dd/mm/aaaa"/></div>
      <div class="row"><label>Hora</label><input id="miHora" type="text" placeholder="hh:mm"/></div>
      <div class="row"><label>Lugar</label><input id="miLugar" type="text" placeholder="Ciudad / trayecto"/></div>
      <div class="row"><label>Actividad</label><input id="miAct" type="text" placeholder="Descripci√≥n"/></div>
      <div class="row"><label>Costo ‚Ç¨</label><input id="miEur" type="number" step="0.01" value="0"/></div>
      <div class="actions"><button onclick="closeAddItModal()">Cancelar</button><button class="primary" onclick="confirmAddIt()">A√±adir</button></div>
    </div>
  </div>

<script>
// --------- Datos base ---------
const CATEGORY_DEFS = {
  VUE:{label:'Vuelos', icon:'‚úàÔ∏è', abbr:'VUE'},
  TRN_BTA:{label:'Transporte Bogot√°', icon:'üöï', abbr:'TRN-BTA'},
  TRN_MDE:{label:'Transporte Medell√≠n', icon:'üöï', abbr:'TRN-MDE'},
  RENT:{label:'Alquiler coche Armenia', icon:'üöó', abbr:'RENT'},
  STY_MDE:{label:'Estad√≠a Medell√≠n', icon:'üè†', abbr:'STY-MDE'},
  STY_AXM:{label:'Estad√≠a Armenia', icon:'üè†', abbr:'STY-AXM'},
  TOUR_MDE:{label:'Tours Medell√≠n', icon:'üéß', abbr:'TOUR-MDE'},
  TOUR_EJE:{label:'Tours Eje Cafetero', icon:'üå¥', abbr:'TOUR-EJE'},
  EXTRA:{label:'Extra', icon:'‚ûï', abbr:'EXT'},
  ROAD_ES:{label:'Roadtrip Espa√±a', icon:'üöô', abbr:'ROAD-ES'}
};

const SAMPLE = {
  fx: 4678.18,
  detalle: [
    {cat:'ROAD_ES', det:'Gasolina Logro√±o (LGR) ‚Üí Madrid (MAD) ¬∑ RAV4', eur:35},
    {cat:'ROAD_ES', det:'Parking MAD (26 Sep ‚Äì 17 Oct)', eur:126},

    {cat:'EXTRA', det:'BOG ‚Üí Villa de Leyva (bus 9 ‚Ç¨/pax x3)', eur:27},

    {cat:'VUE', det:'Jetsmart BOG ‚Üí MDE (3 pax con equipaje)', eur:120},
    {cat:'TRN_MDE', det:'Uber JMC ‚Üí MDE (ida, estim.)', eur:7},
    {cat:'STY_MDE', det:'Apto MDE (jue‚Äìlun, total 1‚Äô060.000 COP)', eur:226.6},
    {cat:'TOUR_MDE', det:'Free tour Comuna 13 (propina 10 ‚Ç¨/pax x3)', eur:30},
    {cat:'TOUR_MDE', det:'Tour Guatap√© (30 ‚Ç¨/pax x3)', eur:90},

    {cat:'VUE', det:'Avianca MDE ‚Üí AXM (3 pax con equipaje)', eur:140},
    {cat:'RENT', det:'Alquiler Kia Picanto (5 d√≠as)', eur:180},
    {cat:'RENT', det:'Seguro adicional (estim.)', eur:50},
    {cat:'RENT', det:'Gasolina + peajes (5 d√≠as)', eur:40},
    {cat:'STY_AXM', det:'Casa Circasia (5 noches)', eur:160},
    {cat:'TOUR_EJE', det:'Entrada Parque del Caf√© (26 ‚Ç¨/pax x3)', eur:78},
    {cat:'TOUR_EJE', det:'Entrada Valle del Cocora (4 ‚Ç¨/pax x3)', eur:12},
    {cat:'TOUR_EJE', det:'Entrada Termales Santa Rosa (10 ‚Ç¨/pax x3)', eur:30},

    {cat:'VUE', det:'Wingo AXM ‚Üí BOG (3 pax con equipaje)', eur:130},
    {cat:'TRN_BTA', det:'Uber Suba ‚Üî Apto El Dorado (ida/vuelta, estim.)', eur:22}
  ],
  itinerario: [
    ['26/09/2025','05:00','LGR ‚Üí MAD','Conducir RAV4 al parking T1/T2/T3',0],
    ['26/09/2025','08:30','MAD (Barajas)','Llegada al parking ¬∑ check-in',0],
    ['26/09/2025','‚Äî','MAD (Barajas)','Vuelo a BOG (pre-embarque)',0],
    ['28/09/2025','09:00','BOG ‚Üí Villa de Leyva','Bus a Villa de Leyva (3 pax)',27],
    ['02/10/2025','14:30','BOG ‚Üí MDE','Vuelo Jetsmart + Uber + Noche MDE',177],
    ['03/10/2025','09:30','MDE','Free Tour Comuna 13 + Noche MDE',86],
    ['04/10/2025','07:00','MDE','Tour Guatap√© + Noche MDE',146],
    ['05/10/2025','10:00','MDE','Pueblito Paisa + Metro/Metrocable + Noche',56],
    ['06/10/2025','16:57','MDE ‚Üí AXM','Vuelo Avianca + Uber + Noche Circasia + Seguro',243],
    ['07/10/2025','08:00','AXM/Circasia','Valle del Cocora + Salento + coche',106],
    ['08/10/2025','09:00','AXM/Circasia','Parque del Caf√© + coche + Noche',154],
    ['09/10/2025','09:00','AXM/Circasia','Filandia + Termales + coche + Noche',106],
    ['10/10/2025','10:00','AXM/Circasia','D√≠a libre + coche + Noche',76],
    ['11/10/2025','18:50','AXM ‚Üí BOG','Coche + Gasolina + Vuelo Wingo + Uber',184],
    ['16/10/2025','‚Äî','BOG ‚Üí MAD','Traslado a El Dorado (Uber XL, 3 pax + 1 gato)',25],
    ['17/10/2025','10:00','MAD (Barajas)','Recoger RAV4 y retorno a LGR',0]
  ],
  stays:[
    {desde:'02/10/2025', hasta:'06/10/2025', lugar:'MDE ¬∑ Apto', nota:'4 noches'},
    {desde:'06/10/2025', hasta:'11/10/2025', lugar:'Circasia ¬∑ Casa', nota:'5 noches'}
  ]
};

// --------- Estado (con persistencia segura) ---------
const KEY='colombia-plan';
function safeParse(str){ try{return JSON.parse(str)}catch(e){return null} }
function loadState(){ const raw = localStorage.getItem(KEY); const obj = safeParse(raw); if(!obj||!Array.isArray(obj.detalle)||!obj.detalle.length) return JSON.parse(JSON.stringify(SAMPLE)); return obj; }
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
let state = loadState();

// --------- Utilidades ---------
function num(v){const n=parseFloat(v||'0');return isFinite(n)?n:0}
function fmtEUR(n){return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(n||0)}
function fmtCOP(n){return new Intl.NumberFormat('es-CO').format(Math.round(n||0))+' COP'}
function parseDMY(s){const [d,m,y]=(s||'').split('/').map(x=>+x);return new Date(y,m-1,d)}
function formatDMY(dt){const d=String(dt.getDate()).padStart(2,'0');const m=String(dt.getMonth()+1).padStart(2,'0');const y=dt.getFullYear();return `${d}/${m}/${y}`}
function addDays(dt,n){const d=new Date(dt);d.setDate(d.getDate()+n);return d}
function weekdayShortEs(date){const s=new Intl.DateTimeFormat('es-ES',{weekday:'short'}).format(date);return s.replace('.', '').slice(0,3).toUpperCase()}

// --------- Abreviador ---------
const CITY_ABBR=[[/bogot√°/gi,'BOG'],[/medell√≠n/gi,'MDE'],[/armenia/gi,'AXM'],[/madrid/gi,'MAD'],[/aeropuerto/gi,'Apto'],[/jose maria c[o√≥]rdoba|jos[e√©] mar[i√≠]a c[o√≥]rdoba|jmc/gi,'JMC'],[/el dorado/gi,'El Dorado'],[/logro√±o|lgr/gi,'LGR']];
function abbrText(s){let t=s||'';CITY_ABBR.forEach(([re,rep])=>{t=t.replace(re,rep)});return t.length>65?t.slice(0,62)+'‚Ä¶':t}

// --------- FX ---------
function saveFX(){ const v=parseFloat(document.getElementById('fx').value||'0'); state.fx=isFinite(v)&&v>0?v:state.fx; document.getElementById('fx').value=state.fx.toFixed(2); saveState(); renderTotals(); renderItTotals(); renderCharts(); }

// --------- Modales ---------
function openAddModal(){ const m=document.getElementById('modalAdd'); const sel=document.getElementById('mCat'); sel.innerHTML = Object.entries(CATEGORY_DEFS).map(([k,v])=>`<option value="${k}">${v.icon} ${v.label}</option>`).join(''); m.style.display='grid'; }
function closeAddModal(){ document.getElementById('modalAdd').style.display='none'; }
function confirmAdd(){ const k=document.getElementById('mCat').value; const d=document.getElementById('mDet').value||'Nuevo √≠tem'; const e=num(document.getElementById('mEur').value); state.detalle.push({cat:k,det:d,eur:e}); saveState(); closeAddModal(); render(); }

function openAddItModal(){ document.getElementById('modalAddIt').style.display='grid'; }
function closeAddItModal(){ document.getElementById('modalAddIt').style.display='none'; }
function confirmAddIt(){ const f=document.getElementById('miFecha').value||''; const h=document.getElementById('miHora').value||''; const l=document.getElementById('miLugar').value||''; const a=document.getElementById('miAct').value||''; const e=num(document.getElementById('miEur').value); state.itinerario.push([f,h,l,a,e]); saveState(); closeAddItModal(); render(); }

// --------- Presupuesto ---------
function delRow(i){ state.detalle.splice(i,1); saveState(); render(); }
function onEditRow(i,field,val){ if(field==='eur') state.detalle[i].eur=num(val); else if(field==='cat') state.detalle[i].cat=val; else state.detalle[i][field]=val; saveState(); render(); }

// --------- Itinerario ---------
function delItRow(i){ state.itinerario.splice(i,1); saveState(); render(); }
function onEditIt(i,j,val){ if(j===4) state.itinerario[i][j]=num(val); else state.itinerario[i][j]=val; saveState(); render(); }

// --------- Orden narrativo (ancla en itinerario) ---------
function reorderPresupuesto(){
  const anchors=[]; // [{date:'dd/mm/aaaa', tokens:Set}]
  const tokenKeys=['LGR','MAD','BOG','SUBA','LEYVA','VILLA','MDE','JMC','AXM','CIRCASIA','SALENTO','FILANDIA','DORADO'];
  const tok= s=>{const t=(abbrText(s||'')+'').toUpperCase();const set=new Set();tokenKeys.forEach(k=>{if(t.includes(k)) set.add(k)});return set};
  const d2n=d=>{const [dd,mm,yy]=d.split('/').map(x=>+x);return yy*10000+mm*100+dd};
  state.itinerario.forEach(it=>anchors.push({date:it[0],tokens:tok(it[2]+' '+it[3])}));
  (state.stays||[]).forEach(st=>{anchors.push({date:st.desde,tokens:tok(st.lugar)});anchors.push({date:st.hasta,tokens:tok(st.lugar)})});
  function score(a,b){let s=0;a.forEach(x=>{if(b.has(x)) s++});return s}
  function inferDate(item){
    const t=tok(item.det||'');
    // Reglas claras
    if(/Villa\s*de\s*Leyva/i.test(item.det)) return '28/09/2025';
    if(/BOG\s*‚Üí\s*MDE|Jetsmart/i.test(item.det)) return '02/10/2025';
    if(/MDE\s*‚Üí\s*AXM|Avianca/i.test(item.det)) return '06/10/2025';
    if(/AXM\s*‚Üí\s*BOG|Wingo/i.test(item.det)) return '11/10/2025';
    if(item.cat==='STY_MDE') return '02/10/2025';
    if(item.cat==='STY_AXM') return '06/10/2025';
    if(item.cat==='ROAD_ES') return '26/09/2025';
    // Coincidencia con anchors
    let best='31/12/2099', bestS=-1;
    anchors.forEach(a=>{const s=score(t,a.tokens); if(s>bestS || (s===bestS && d2n(a.date)<d2n(best))) {bestS=s;best=a.date}});
    return best;
  }
  state.detalle.sort((a,b)=>{const da=inferDate(a), db=inferDate(b); const na=da?da:'31/12/2099', nb=db?db:'31/12/2099'; const A=na.split('/').reverse().join('-'), B=nb.split('/').reverse().join('-'); if(A!==B) return A<B?-1:1; return (a.det||'').localeCompare(b.det||'')});
}

// --------- Render ---------
function fillCatFilter(){ const sel=document.getElementById('filterCat'); const keep=sel.value; const cats=[...new Set(state.detalle.map(r=>r.cat))]; sel.innerHTML='<option value="">Todas</option>'+cats.map(c=>`<option value="${c}">${(CATEGORY_DEFS[c]||{label:c,icon:'üßæ'}).icon} ${(CATEGORY_DEFS[c]||{label:c}).label}</option>`).join(''); sel.value=keep||''; }

function renderTables(){
  const txt=(document.getElementById('filterText').value||'').toLowerCase(); const cat=document.getElementById('filterCat').value||'';
  const tb=document.getElementById('tbody-detalle'); tb.innerHTML='';
  state.detalle.filter(r=>(!cat||r.cat===cat)&&(!txt||(r.det||'').toLowerCase().includes(txt))).forEach((r,i)=>{
    const def=CATEGORY_DEFS[r.cat]||{icon:'üßæ',abbr:r.cat,label:r.cat};
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td title="${def.label}"><select onchange="onEditRow(${i},'cat',this.value)"> ${Object.entries(CATEGORY_DEFS).map(([k,v])=>`<option value="${k}" ${k===r.cat?'selected':''}>${v.icon} ${v.abbr}</option>`).join('')} </select></td>
      <td title="${r.det}"><input type="text" value="${abbrText(r.det)}" oninput="onEditRow(${i},'det',this.value)"/></td>
      <td class="right"><input class="eur-input" type="number" step="0.01" value="${r.eur}" oninput="onEditRow(${i},'eur',this.value)"/></td>
      <td class="right cop">${fmtCOP(r.eur*state.fx)}</td>
      <td class="right"><button onclick="delRow(${i})">üóëÔ∏è</button></td>`;
    tb.appendChild(tr);
  });

  const tbi=document.getElementById('tbody-it'); tbi.innerHTML=''; const ft=(document.getElementById('filterIt').value||'').toLowerCase();
  state.itinerario.filter(it=>(!ft||(it[1]+" "+it[2]+" "+it[3]).toLowerCase().includes(ft))).forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" value="${it[0]}" oninput="onEditIt(${i},0,this.value)"/></td>
      <td><input type="text" value="${it[1]}" oninput="onEditIt(${i},1,this.value)"/></td>
      <td><input type="text" value="${abbrText(it[2])}" oninput="onEditIt(${i},2,this.value)"/></td>
      <td><input type="text" value="${abbrText(it[3])}" oninput="onEditIt(${i},3,this.value)"/></td>
      <td class="right"><input class="eur-input" type="number" step="0.01" value="${it[4]}" oninput="onEditIt(${i},4,this.value)"/></td>
      <td class="right cop">${fmtCOP(it[4]*state.fx)}</td>
      <td class="right"><button onclick="delItRow(${i})">üóëÔ∏è</button></td>`;
    tbi.appendChild(tr);
  });
}

function renderTotals(){ const e=state.detalle.reduce((a,b)=>a+(+b.eur||0),0); const c=e*state.fx; document.getElementById('total-eur').textContent=fmtEUR(e); document.getElementById('total-cop').textContent=fmtCOP(c); }
function renderItTotals(){ const e=state.itinerario.reduce((a,b)=>a+(+b[4]||0),0); const c=e*state.fx; document.getElementById('tot-it-eur').textContent=fmtEUR(e); document.getElementById('tot-it-cop').textContent=fmtCOP(c); }

let barChart, pieChart;
function groupByCategoryNarrative(){
  const txt=(document.getElementById('filterText').value||'').toLowerCase(); const cat=document.getElementById('filterCat').value||'';
  const rows=state.detalle.filter(r=>(!cat||r.cat===cat)&&(!txt||(r.det||'').toLowerCase().includes(txt)));
  const sum=new Map(), order=new Map();
  rows.forEach((r,idx)=>{ sum.set(r.cat,(sum.get(r.cat)||0)+(+r.eur||0)); if(!order.has(r.cat)) order.set(r.cat,idx); });
  const cats=[...sum.keys()].sort((a,b)=>(order.get(a)||0)-(order.get(b)||0));
  return {labels: cats.map(k=>`${(CATEGORY_DEFS[k]||{icon:'üßæ',abbr:k}).icon} ${(CATEGORY_DEFS[k]||{abbr:k}).abbr}`), values: cats.map(k=>sum.get(k))};
}
function renderCharts(){ const {labels,values}=groupByCategoryNarrative(); const ctx1=document.getElementById('barChart'), ctx2=document.getElementById('pieChart'); const colors=['#22c55e','#60a5fa','#f59e0b','#f472b6','#a78bfa','#06b6d4','#94a3b8','#84cc16','#ef4444','#10b981']; if(barChart) barChart.destroy(); barChart=new Chart(ctx1,{type:'bar',data:{labels,datasets:[{label:'Gasto (‚Ç¨)',data:values,backgroundColor:labels.map((_,i)=>colors[i%colors.length])}]},options:{responsive:true,plugins:{legend:{display:false}}}}); if(pieChart) pieChart.destroy(); pieChart=new Chart(ctx2,{type:'pie',data:{labels,datasets:[{data:values,backgroundColor:labels.map((_,i)=>colors[i%colors.length])}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}}); }

function buildCalendarList(){ const host=document.getElementById('calendarList'); host.innerHTML=''; const by={}; state.itinerario.forEach(it=>{const k=it[0]||'Sin fecha'; (by[k]=by[k]||[]).push({hora:it[1]||'',lugar:it[2],act:it[3]})}); (state.stays||[]).forEach(st=>{const from=parseDMY(st.desde), to=parseDMY(st.hasta); if(!isNaN(from)&&!isNaN(to)){ for(let d=from; d<=to; d=addDays(d,1)){ const k=formatDMY(d); (by[k]=by[k]||[]); if(d.getTime()===from.getTime()) by[k].push({hora:'15:00',lugar:st.lugar,act:'Check-in'}); else if(d.getTime()===to.getTime()) by[k].push({hora:'11:00',lugar:st.lugar,act:'Check-out'}); else by[k].push({hora:'',lugar:st.lugar,act:st.nota?`Estad√≠a ¬∑ ${st.nota}`:'Estad√≠a'}); } }});
  const keys=Object.keys(by).sort((a,b)=>a.split('/').reverse().join('-').localeCompare(b.split('/').reverse().join('-')));
  keys.forEach(k=>{ const dt=parseDMY(k); const wd=isNaN(dt)?'':weekdayShortEs(dt); const col=document.createElement('div'); col.style.cssText='background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px;min-height:160px'; col.innerHTML=`<div style="display:flex;justify-content:space-between;font-weight:700;color:#334155;margin-bottom:6px"><span>${k}</span><span>${wd}</span></div>`; (by[k].sort((a,b)=>(a.hora||'').localeCompare(b.hora||''))).forEach(it=>{ const el=document.createElement('div'); el.style.cssText='border-left:2px solid #e5e7eb;margin-left:4px;padding-left:8px;margin-bottom:6px'; el.innerHTML=`<div style="font-size:12px;color:#64748b">${it.hora||'‚Äî:‚Äî'}</div><div style="font-size:14px">${abbrText(it.lugar)} ¬∑ ${abbrText(it.act)}</div>`; col.appendChild(el); }); host.appendChild(col); }); }

// --------- Render master ---------
function applyFilter(){ renderTables(); renderCharts(); buildCalendarList(); }
function render(){ document.getElementById('fx').value=state.fx.toFixed(2); reorderPresupuesto(); fillCatFilter(); renderTables(); renderTotals(); renderItTotals(); renderCharts(); buildCalendarList(); }
function resetData(){ state=JSON.parse(JSON.stringify(SAMPLE)); saveState(); render(); }

// Init
render();
</script>
</body>
</html>
