<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Plan de Viaje ‚Äî Presupuesto & Itinerario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:#f6f7fb;color:#0b1020;font-size:16px;overflow-x:hidden}
    .container{width:min(100%,1040px);margin:auto;padding:10px}
    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
    h1{font-size:20px;margin:8px 0 10px}
    h2{font-size:17px;margin:0 0 8px;color:#334155}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button{font:inherit}
    input[type="number"],input[type="text"],select{background:#eef2ff;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px}
    button{background:#f1f5f9;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;cursor:pointer}
    button.primary{background:#22c55e;color:#fff;border:none;font-weight:600}

    .table-wrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:separate;border-spacing:0 6px;table-layout:fixed}
    col.col-cat{width:90px} col.col-det{width:clamp(180px,50%,65ch)} col.col-eur{width:64px} col.col-cop{width:13ch} col.col-act{width:36px}
    thead th{font-size:12px;color:#5b6476;border-bottom:1px solid #e5e7eb;text-align:left;padding:6px}
    tbody tr{background:#f8fafc;border:1px solid #e5e7eb}
    td{padding:6px}
    td.right{text-align:right;white-space:nowrap}
    td.cop{font-size:0.9rem}
    .eur-input{width:56px;text-align:right}

    canvas{width:100% !important;height:auto !important;background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:6px}
    .note{font-size:12px;color:#5b6476}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Plan de Viaje ‚Äî Presupuesto & Itinerario</h1>

    <div class="cards">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Gr√°ficos (gastos en ‚Ç¨ por categor√≠a)</h2>
          <div class="row">
            <label for="fx" class="note">Tipo de cambio EUR‚ÜíCOP</label>
            <input id="fx" type="number" step="0.01" value="4678.18" style="width:100px"/>
            <button class="primary" onclick="saveFX()">Actualizar</button>
          </div>
        </div>
        <canvas id="barChart"></canvas>
        <div style="height:8px"></div>
        <canvas id="pieChart"></canvas>
        <p class="note">Los gr√°ficos usan importes en euros. Las tablas muestran ‚Ç¨ y COP (seg√∫n el tipo de cambio editable).</p>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Presupuesto detallado</h2>
          <div class="row">
            <select id="filterCat" onchange="applyFilter()"><option value="">Todas</option></select>
            <input id="filterText" type="text" placeholder="Filtrar‚Ä¶" oninput="applyFilter()" />
            <button class="primary" onclick="openAddModal()">+ A√±adir</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <colgroup><col class="col-cat"><col class="col-det"><col class="col-eur"><col class="col-cop"><col class="col-act"></colgroup>
            <thead><tr><th>Cat</th><th>Detalle</th><th class="right">‚Ç¨</th><th class="right">COP</th><th></th></tr></thead>
            <tbody id="tbody-detalle"></tbody>
            <tfoot><tr><td></td><td class="right">TOTAL</td><td id="total-eur" class="right">0</td><td id="total-cop" class="right">0</td><td></td></tr></tfoot>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Itinerario</h2>
          <div class="row">
            <input id="filterIt" type="text" placeholder="Filtrar‚Ä¶" oninput="applyFilter()" />
            <button class="primary" onclick="openAddItModal()">+ A√±adir d√≠a</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <colgroup><col style="width:100px"><col style="width:70px"><col class="col-det"><col class="col-det"><col class="col-eur"><col class="col-cop"><col class="col-act"></colgroup>
            <thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th><th>Actividad</th><th class="right">‚Ç¨</th><th class="right">COP</th><th></th></tr></thead>
            <tbody id="tbody-it"></tbody>
            <tfoot><tr><td></td><td></td><td></td><td class="right">TOTAL</td><td id="tot-it-eur" class="right">0</td><td id="tot-it-cop" class="right">0</td><td></td></tr></tfoot>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
// ==========================
//  Plan Colombia ‚Äî Script
//  (estable, responsivo y con orden narrativo)
// ==========================

// ---------- Abreviaturas visuales ----------
const CITY_ABBR = [
  [/bogot√°/gi,'BOG'], [/medell√≠n/gi,'MDE'], [/armenia/gi,'AXM'], [/madrid/gi,'MAD'],
  [/aeropuerto/gi,'Apto'], [/jose maria c[o√≥]rdoba|jos[e√©] mar[i√≠]a c[o√≥]rdoba|jmc/gi,'JMC'],
  [/el dorado/gi,'El Dorado'], [/logro√±o|lgr/gi,'LGR']
];
function abbrText(s){ let t = s||''; CITY_ABBR.forEach(([re,rep])=>{ t = t.replace(re,rep); }); return t.length>65 ? t.slice(0,62)+'‚Ä¶' : t; }

// ---------- Categor√≠as ----------
const CATEGORY_DEFS = {
  VUE:{label:'Vuelos', icon:'‚úàÔ∏è', abbr:'VUE'},
  TRN_BTA:{label:'Transporte Bogot√°', icon:'üöï', abbr:'TRN-BTA'},
  TRN_MDE:{label:'Transporte Medell√≠n', icon:'üöï', abbr:'TRN-MDE'},
  TRN_AXM:{label:'Transporte Armenia', icon:'üöï', abbr:'TRN-AXM'},
  RENT:{label:'Alquiler coche Armenia', icon:'üöó', abbr:'RENT'},
  STY_MDE:{label:'Estad√≠a Medell√≠n', icon:'üè†', abbr:'STY-MDE'},
  STY_AXM:{label:'Estad√≠a Armenia', icon:'üè†', abbr:'STY-AXM'},
  TOUR_MDE:{label:'Tours Medell√≠n', icon:'üéß', abbr:'TOUR-MDE'},
  TOUR_EJE:{label:'Tours Eje Cafetero', icon:'üå¥', abbr:'TOUR-EJE'},
  EXTRA:{label:'Extra', icon:'‚ûï', abbr:'EXT'},
  ROAD_ES:{label:'Roadtrip Espa√±a', icon:'üöô', abbr:'ROAD-ES'}
};

// ---------- Estado inicial ----------
const SAMPLE = {
  fx: 4678.18,
  detalle: [
    {cat:'VUE', det:'Jetsmart BOG ‚Üí MDE (3 pax con equipaje)', eur:120},
    {cat:'VUE', det:'Avianca MDE ‚Üí AXM (3 pax con equipaje)', eur:140},
    {cat:'VUE', det:'Wingo AXM ‚Üí BOG (3 pax con equipaje)', eur:130},
    {cat:'TRN_BTA', det:'Uber Suba ‚Üî Apto El Dorado (ida/vuelta, estim.)', eur:22},
    {cat:'TRN_MDE', det:'Uber JMC ‚Üí MDE (ida, estim.)', eur:7},
    {cat:'TRN_MDE', det:'Uber MDE ‚Üí JMC (vuelta, estim.)', eur:7},
    {cat:'RENT', det:'Alquiler Kia Picanto (5 d√≠as)', eur:180},
    {cat:'RENT', det:'Seguro adicional (estim.)', eur:50},
    {cat:'RENT', det:'Gasolina + peajes (5 d√≠as)', eur:40},
    {cat:'STY_MDE', det:'Apto MDE (jue‚Äìlun, total 1‚Äô060.000 COP)', eur:226.6},
    {cat:'STY_AXM', det:'Casa Circasia (5 noches)', eur:160},
    {cat:'TOUR_MDE', det:'Free tour Comuna 13 (propina 10 ‚Ç¨/pax x3)', eur:30},
    {cat:'TOUR_MDE', det:'Tour Guatap√© (30 ‚Ç¨/pax x3)', eur:90},
    {cat:'TOUR_EJE', det:'Entrada Parque del Caf√© (26 ‚Ç¨/pax x3)', eur:78},
    {cat:'TOUR_EJE', det:'Entrada Valle del Cocora (4 ‚Ç¨/pax x3)', eur:12},
    {cat:'TOUR_EJE', det:'Entrada Termales Santa Rosa (10 ‚Ç¨/pax x3)', eur:30},
    {cat:'EXTRA', det:'BOG ‚Üí Villa de Leyva (bus 9 ‚Ç¨/pax x3)', eur:27},
    {cat:'ROAD_ES', det:'Parking MAD (26 Sep ‚Äì 17 Oct)', eur:126},
    {cat:'ROAD_ES', det:'Gasolina LGR ‚Üí MAD (RAV4, est.)', eur:35},
  ],
  itinerario: [
    ['26/09/2025','05:00','LGR ‚Üí MAD','Conducir RAV4 al parking T1/T2/T3',0],
    ['26/09/2025','08:30','MAD (Barajas)','Llegada al parking ¬∑ check-in',0],
    ['26/09/2025','‚Äî','MAD (Barajas)','Vuelo a BOG (pre-embarque)',0],
    ['28/09/2025','09:00','BOG ‚Üí Villa de Leyva','Bus a Villa de Leyva (3 pax)',27],
    ['02/10/2025','14:30','BOG ‚Üí MDE','Vuelo Jetsmart + Uber + Noche MDE',177],
    ['03/10/2025','09:30','MDE','Free Tour Comuna 13 + Noche MDE',86],
    ['04/10/2025','07:00','MDE','Tour Guatap√© + Noche MDE',146],
    ['05/10/2025','10:00','MDE','Pueblito Paisa + Metro/Metrocable + Noche',56],
    ['06/10/2025','16:57','MDE ‚Üí AXM','Vuelo Avianca + Uber + Noche Circasia + Seguro',243],
    ['07/10/2025','08:00','AXM/Circasia','Valle del Cocora + Salento + coche',106],
    ['08/10/2025','09:00','AXM/Circasia','Parque del Caf√© + coche + Noche',154],
    ['09/10/2025','09:00','AXM/Circasia','Filandia + Termales + coche + Noche',106],
    ['10/10/2025','10:00','AXM/Circasia','D√≠a libre + coche + Noche',76],
    ['11/10/2025','18:50','AXM ‚Üí BOG','Coche + Gasolina + Vuelo Wingo + Uber',184],
    ['16/10/2025','‚Äî','BOG ‚Üí MAD','Traslado a El Dorado (Uber XL, 3 pax + 1 gato)',25],
    ['17/10/2025','10:00','MAD (Barajas)','Recoger RAV4 y retorno a LGR',0],
  ],
  stays: [
    {desde:'02/10/2025', hasta:'06/10/2025', lugar:'MDE ¬∑ Apto', nota:'4 noches'},
    {desde:'06/10/2025', hasta:'11/10/2025', lugar:'Circasia ¬∑ Casa', nota:'5 noches'}
  ]
};

// ---------- Estado + persistencia ----------
const KEY='colombia-plan';
function clone(o){ return JSON.parse(JSON.stringify(o)); }
function normalize(s){ const base=clone(SAMPLE); if(!s||typeof s!=='object') return base; s.fx=+s.fx>0?+s.fx:base.fx; if(!Array.isArray(s.detalle)||!s.detalle.length) s.detalle=base.detalle; if(!Array.isArray(s.itinerario)||!s.itinerario.length) s.itinerario=base.itinerario; if(!Array.isArray(s.stays)||!s.stays.length) s.stays=base.stays; return s; }
function loadState(){ try{ const raw=localStorage.getItem(KEY); if(!raw) return clone(SAMPLE); const obj=JSON.parse(raw); return normalize(obj); }catch(e){ return clone(SAMPLE); } }
function saveState(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }
let state = loadState();

// ---------- Utils ----------
function num(v){ const n=parseFloat(v||'0'); return isFinite(n)?n:0; }
function fmtEUR(n){ return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(n||0); }
function fmtCOP(n){ const v=Math.round(n||0); const isMob=(typeof window!=='undefined'&&window.innerWidth<=600); if(isMob){ if(v>=1000000) return (v/1000000).toFixed(2).replace(/\.?0+$/,'')+'M COP'; if(v>=1000) return Math.round(v/1000)+'K COP'; } return new Intl.NumberFormat('es-CO').format(v)+' COP'; }
if(typeof window!=='undefined'){ window.addEventListener('resize', ()=>{ renderTables(); renderTotals(); renderItTotals(); }); }
function parseDMY(s){ const [d,m,y]=(s||'').split('/').map(x=>+x); return new Date(y,m-1,d); }
function formatDMY(dt){ const d=String(dt.getDate()).padStart(2,'0'); const m=String(dt.getMonth()+1).padStart(2,'0'); const y=dt.getFullYear(); return `${d}/${m}/${y}`; }
function addDays(dt,n){ const d=new Date(dt); d.setDate(d.getDate()+n); return d; }
function weekdayShortEs(date){ const s=new Intl.DateTimeFormat('es-ES',{weekday:'short'}).format(date); return s.replace('.', '').slice(0,3).toUpperCase(); }

// ---------- FX ----------
function saveFX(){ const v=parseFloat(document.getElementById('fx').value||'0'); state.fx=isFinite(v)&&v>0?v:state.fx; document.getElementById('fx').value=state.fx.toFixed(2); saveState(); renderTotals(); renderItTotals(); renderCharts(); renderTables(); }

// ---------- Modales ----------
function openAddModal(){ const m=document.getElementById('modalAdd'); const sel=document.getElementById('mCat'); sel.innerHTML=Object.entries(CATEGORY_DEFS).map(([k,v])=>`<option value="${k}">${v.icon} ${v.label}</option>`).join(''); m.style.display='flex'; }
function closeAddModal(){ document.getElementById('modalAdd').style.display='none'; }
function confirmAdd(){ const k=document.getElementById('mCat').value; const d=document.getElementById('mDet').value||'Nuevo √≠tem'; const e=num(document.getElementById('mEur').value); state.detalle.push({cat:k, det:d, eur:e}); saveState(); closeAddModal(); render(); }

function openAddItModal(){ document.getElementById('modalAddIt').style.display='flex'; }
function closeAddItModal(){ document.getElementById('modalAddIt').style.display='none'; }
function confirmAddIt(){ const f=document.getElementById('miFecha').value||''; const h=document.getElementById('miHora').value||''; const l=document.getElementById('miLugar').value||''; const a=document.getElementById('miAct').value||''; const e=num(document.getElementById('miEur').value); state.itinerario.push([f,h,l,a,e]); saveState(); closeAddItModal(); render(); }

function openStayModal(){ document.getElementById('modalStay').style.display='flex'; }
function closeStayModal(){ document.getElementById('modalStay').style.display='none'; }
function confirmStay(){ const d=document.getElementById('stDesde').value||''; const h=document.getElementById('stHasta').value||''; const l=document.getElementById('stLugar').value||''; const n=document.getElementById('stNota').value||''; if(d&&h&&l){ state.stays.push({desde:d,hasta:h,lugar:l,nota:n}); saveState(); buildCalendars(); } closeStayModal(); }

// ---------- Presupuesto Detallado ----------
function delRow(i){ state.detalle.splice(i,1); saveState(); render(); }
function onEditRow(i,field,val){ if(field==='eur') state.detalle[i].eur=num(val); else if(field==='cat') state.detalle[i].cat=val; else state.detalle[i][field]=val; saveState(); render(); }

// ---------- Itinerario ----------
function delItRow(i){ state.itinerario.splice(i,1); saveState(); render(); }
function onEditIt(i,j,val){ if(j===4) state.itinerario[i][j]=num(val); else state.itinerario[i][j]=val; saveState(); render(); }

// ---------- Filtros ----------
function applyFilter(){ renderTables(); renderCharts(); buildCalendars(); }

// ---------- Render maestro ----------
function render(){ document.getElementById('fx').value=state.fx.toFixed(2); fillCatFilter(); reorderPresupuesto(); renderTables(); renderTotals(); renderItTotals(); renderCharts(); buildCalendars(); }

function fillCatFilter(){ const sel=document.getElementById('filterCat'); const keep=sel.value; const cats=[...new Set(state.detalle.map(r=>r.cat||'OTROS'))].sort(); sel.innerHTML='<option value="">Todas</option>'+cats.map(c=>{ const def=CATEGORY_DEFS[c]||{icon:'üßæ',label:c}; return `<option value="${c}">${def.icon} ${def.label}</option>`; }).join(''); sel.value=keep||''; }

function renderTables(){
  const txt=(document.getElementById('filterText').value||'').toLowerCase(); const cat=document.getElementById('filterCat').value||'';
  // Detalle
  const tb=document.getElementById('tbody-detalle'); tb.innerHTML='';
  state.detalle.filter(r=>(!cat||r.cat===cat)&&(!txt||(r.det||'').toLowerCase().includes(txt))).forEach((r,idx)=>{
    const def=CATEGORY_DEFS[r.cat]||{icon:'üßæ',abbr:r.cat,label:r.cat};
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td title="${def.label}">
        <select onchange="onEditRow(${idx},'cat',this.value)">
          ${Object.entries(CATEGORY_DEFS).map(([k,v])=>`<option value="${k}" ${k===r.cat?'selected':''}>${v.icon} ${v.abbr}</option>`).join('')}
        </select>
      </td>
      <td title="${r.det}"><input type="text" value="${abbrText(r.det)}" oninput="onEditRow(${idx},'det',this.value)"/></td>
      <td class="right"><input class="eur-input" type="number" step="0.01" value="${r.eur}" oninput="onEditRow(${idx},'eur',this.value)"/></td>
      <td class="right cop">${fmtCOP(r.eur*state.fx)}</td>
      <td class="right"><button class="icon-btn" title="Eliminar" onclick="delRow(${idx})">üóëÔ∏è</button></td>`;
    tb.appendChild(tr);
  });

  // Itinerario
  const ft=(document.getElementById('filterIt').value||'').toLowerCase();
  const tbi=document.getElementById('tbody-it'); tbi.innerHTML='';
  state.itinerario.filter(it=>(!ft||(it[1]+" "+it[2]+" "+it[3]).toLowerCase().includes(ft))).forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" value="${it[0]}" oninput="onEditIt(${i},0,this.value)"/></td>
      <td><input type="text" value="${it[1]}" oninput="onEditIt(${i},1,this.value)"/></td>
      <td><input type="text" value="${abbrText(it[2])}" oninput="onEditIt(${i},2,this.value)"/></td>
      <td><input type="text" value="${abbrText(it[3])}" oninput="onEditIt(${i},3,this.value)"/></td>
      <td class="right"><input class="eur-input" type="number" step="0.01" value="${it[4]}" oninput="onEditIt(${i},4,this.value)"/></td>
      <td class="right cop">${fmtCOP(it[4]*state.fx)}</td>
      <td class="right"><button class="icon-btn" title="Eliminar" onclick="delItRow(${i})">üóëÔ∏è</button></td>`;
    tbi.appendChild(tr);
  });
}

function renderTotals(){ const e=state.detalle.reduce((a,b)=>a+(+b.eur||0),0); const c=e*state.fx; document.getElementById('total-eur').textContent=fmtEUR(e); document.getElementById('total-cop').textContent=fmtCOP(c); }
function renderItTotals(){ const e=state.itinerario.reduce((a,b)=>a+(+b[4]||0),0); const c=e*state.fx; document.getElementById('tot-it-eur').textContent=fmtEUR(e); document.getElementById('tot-it-cop').textContent=fmtCOP(c); }

// ---------- Gr√°ficos ----------
let barChart, pieChart;
function groupByCategory(){
  const txt=(document.getElementById('filterText').value||'').toLowerCase();
  const catFilter=document.getElementById('filterCat').value||'';
  const rows=state.detalle.filter(r => (!catFilter||r.cat===catFilter) && (!txt||(r.det||'').toLowerCase().includes(txt)) );
  const sum=new Map(), order=new Map();
  rows.forEach((r,idx)=>{ sum.set(r.cat,(sum.get(r.cat)||0)+(+r.eur||0)); if(!order.has(r.cat)) order.set(r.cat,idx); });
  const cats=[...sum.keys()].sort((a,b)=>(order.get(a)||0)-(order.get(b)||0));
  const labels=cats.map(k=>{ const d=CATEGORY_DEFS[k]||{icon:'üßæ',abbr:k}; return `${d.icon} ${d.abbr}`; });
  const values=cats.map(k=>sum.get(k));
  return {labels,values};
}
function renderCharts(){ const {labels,values}=groupByCategory(); const ctx1=document.getElementById('barChart'); const ctx2=document.getElementById('pieChart'); const colors=['#22c55e','#60a5fa','#f59e0b','#f472b6','#a78bfa','#06b6d4','#94a3b8','#84cc16','#ef4444','#10b981']; if(barChart) barChart.destroy(); barChart=new Chart(ctx1,{type:'bar',data:{labels,datasets:[{label:'Gasto (‚Ç¨)',data:values,backgroundColor:labels.map((_,i)=>colors[i%colors.length])}]},options:{responsive:true,plugins:{legend:{display:false}}}}); if(pieChart) pieChart.destroy(); pieChart=new Chart(ctx2,{type:'pie',data:{labels,datasets:[{data:values,backgroundColor:labels.map((_,i)=>colors[i%colors.length])}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}}); }

// ---------- Clima (promedio mensual, sin red) ----------
const CLIMATE_LOCAL={ BOG:{'09':{tmin:9,tmax:20,pp:3},'10':{tmin:9,tmax:19,pp:5}}, MDE:{'09':{tmin:17,tmax:28,pp:6},'10':{tmin:17,tmax:27,pp:7}}, AXM:{'09':{tmin:16,tmax:26,pp:7},'10':{tmin:16,tmax:25,pp:8}}, MAD:{'09':{tmin:15,tmax:28,pp:1},'10':{tmin:11,tmax:21,pp:2}}, };
function pickCityCode(text){ const t=(text||'').toUpperCase(); if(t.includes('MDE')||t.includes('MEDELL')) return 'MDE'; if(t.includes('AXM')||t.includes('CIRCASIA')||t.includes('ARMENIA')) return 'AXM'; if(t.includes('BOG')||t.includes('SUBA')) return 'BOG'; if(t.includes('MAD')||t.includes('BARAJAS')||t.includes('LGR')||t.includes('LOGRO')) return 'MAD'; return 'MDE'; }
function getWxLocal(dateStr,placeText){ const code=pickCityCode(abbrText(placeText||'')); const month=(dateStr||'01/01/2000').split('/')[1]; const m=(CLIMATE_LOCAL[code]||{})[month]||{}; const rainy=(m.pp||0)>2; return {code,tmin:m.tmin,tmax:m.tmax,rainy}; }

// ---------- Calendarios ----------
function switchCal(which){ document.getElementById('tabList').classList.toggle('active', which==='list'); document.getElementById('tabAgenda').classList.toggle('active', which==='agenda'); document.getElementById('calendarList').style.display=which==='list'?'grid':'none'; document.getElementById('calendarAgenda').style.display=which==='agenda'?'grid':'none'; }
function buildCalendars(){ buildListCalendar(); buildAgendaCalendar(); }
function buildListCalendar(){
  const host=document.getElementById('calendarList'); host.innerHTML=''; const by={};
  state.itinerario.forEach(it=>{ const [fecha,hora,lugar,act]=it; const k=fecha||'Sin fecha'; (by[k]=by[k]||[]).push({hora:hora||'',lugar,act}); });
  (state.stays||[]).forEach(st=>{ const from=parseDMY(st.desde), to=parseDMY(st.hasta); if(!isNaN(from)&&!isNaN(to)){ for(let d=from; d<=to; d=addDays(d,1)){ const k=formatDMY(d); (by[k]=by[k]||[]); const isStart=d.getTime()===from.getTime(); const isEnd=d.getTime()===to.getTime(); if(isStart) by[k].push({hora:'15:00',lugar:st.lugar,act:'Check-in'}); if(isEnd) by[k].push({hora:'11:00',lugar:st.lugar,act:'Check-out'}); if(!isStart&&!isEnd) by[k].push({hora:'',lugar:st.lugar,act:st.nota?`Estad√≠a ¬∑ ${st.nota}`:'Estad√≠a'}); } } });
  const keys=Object.keys(by).sort((a,b)=>a.split('/').reverse().join('-').localeCompare(b.split('/').reverse().join('-')));
  keys.forEach(k=>{ const dt=parseDMY(k); const wd=isNaN(dt)?'':weekdayShortEs(dt); const col=document.createElement('div'); col.className='day-col'; col.innerHTML=`<div class="day-header"><span>${k}</span><span>${wd}</span></div>`; const wx=getWxLocal(k, by[k][0]?.lugar||''); const rain=wx.rainy?'üåßÔ∏è':'‚òÄÔ∏è'; const tmin=wx.tmin!=null?Math.round(wx.tmin):'‚Äî'; const tmax=wx.tmax!=null?Math.round(wx.tmax):'‚Äî'; const wxp=document.createElement('div'); wxp.className='wx'; wxp.textContent=`${rain} ${wx.code} ¬∑ ${tmin}‚Äì${tmax}¬∞C (prom.)`; col.appendChild(wxp); const items=by[k].sort((a,b)=>(a.hora||'').localeCompare(b.hora||'')); items.forEach(it=>{ const el=document.createElement('div'); el.className='slot'; el.innerHTML=`<div class="time">${it.hora||'‚Äî:‚Äî'}</div><div class="title">${abbrText(it.lugar)} ¬∑ ${abbrText(it.act)}</div>`; col.appendChild(el); }); host.appendChild(col); });
}
function buildAgendaCalendar(){
  const host=document.getElementById('calendarAgenda'); host.innerHTML=''; const HSTART=6, HEND=22, PIX_PER_H=54; const yFrom=(hm)=>{ if(!hm||hm==='‚Äî') return 0; const [h,m]=hm.split(':').map(x=>+x||0); const t=(h*60+m)-HSTART*60; return Math.max(0,Math.min((HEND-HSTART)*60,t))/60*PIX_PER_H; };
  const by={}; state.itinerario.forEach(it=>{ const [fecha,hora,lugar,act]=it; const k=fecha||'Sin fecha'; (by[k]=by[k]||[]).push({hora:hora||'08:00',dur:60,lugar,act}); });
  (state.stays||[]).forEach(st=>{ const from=parseDMY(st.desde), to=parseDMY(st.hasta); if(!isNaN(from)&&!isNaN(to)){ for(let d=from; d<=to; d=addDays(d,1)){ const k=formatDMY(d); (by[k]=by[k]||[]); const isStart=d.getTime()===from.getTime(); const isEnd=d.getTime()===to.getTime(); if(isStart) by[k].push({hora:'15:00',dur:60,lugar:st.lugar,act:'Check-in',stay:true}); if(isEnd) by[k].push({hora:'11:00',dur:60,lugar:st.lugar,act:'Check-out',stay:true}); if(!isStart&&!isEnd) by[k].push({hora:'09:00',dur:120,lugar:st.lugar,act:st.nota?`Estad√≠a ¬∑ ${st.nota}`:'Estad√≠a',stay:true}); } } });
  const keys=Object.keys(by).sort((a,b)=>a.split('/').reverse().join('-').localeCompare(b.split('/').reverse().join('-')));
  keys.forEach(k=>{ const dt=parseDMY(k); const wd=isNaN(dt)?'':weekdayShortEs(dt); const col=document.createElement('div'); col.className='agenda-day'; col.innerHTML=`<div class="agenda-header"><span>${k}</span><span>${wd}</span></div>`; const wx=getWxLocal(k,by[k][0]?.lugar||''); const rain=wx.rainy?'üåßÔ∏è':'‚òÄÔ∏è'; const tmin=wx.tmin!=null?Math.round(wx.tmin):'‚Äî'; const tmax=wx.tmax!=null?Math.round(wx.tmax):'‚Äî'; const wxp=document.createElement('div'); wxp.className='wx'; wxp.textContent=`${rain} ${wx.code} ¬∑ ${tmin}‚Äì${tmax}¬∞C (prom.)`; col.appendChild(wxp); const hours=document.createElement('div'); hours.className='hours'; for(let h=HSTART;h<=HEND;h++){ const line=document.createElement('div'); line.className='hour-line'; line.style.top=((h-HSTART)*PIX_PER_H)+'px'; hours.appendChild(line); const label=document.createElement('div'); label.className='hour-label'; label.style.top=((h-HSTART)*PIX_PER_H)+'px'; label.textContent=String(h).padStart(2,'0')+':00'; hours.appendChild(label); } const items=by[k].sort((a,b)=>(a.hora||'').localeCompare(b.hora||'')); items.forEach(it=>{ const block=document.createElement('div'); block.className='block'+(it.stay?' stay':''); block.style.top=yFrom(it.hora)+'px'; block.style.height=((it.dur||60)/60*PIX_PER_H)+'px'; block.innerHTML=`<div class="btime">${it.hora} ¬∑ ${abbrText(it.lugar)}</div><div class="btitle">${abbrText(it.act)}</div>`; hours.appendChild(block); }); col.appendChild(hours); host.appendChild(col); });
}

// ---------- Sync GitHub (opcional; modal existe en HTML) ----------
function openSyncModal(){ document.getElementById('modalSync').style.display='flex'; }
function closeSyncModal(){ document.getElementById('modalSync').style.display='none'; }
async function saveToGitHub(){ /* opcional: implementado previamente; aqu√≠ mantenemos stub m√≠nimo */ closeSyncModal(); alert('Para habilitar guardado a GitHub, vuelve a activar el token en el modal.'); }

// ---------- Orden narrativo ----------
function reorderPresupuesto(){
  function d2n(dmy){ const [d,m,y]=dmy.split('/').map(x=>+x); return y*10000+m*100+d; }
  function tokens(s){ const t=(abbrText(s||'')+'').toUpperCase(); const set=new Set(); const keys=['BOG','MDE','AXM','MAD','JMC','LGR','VILLA','LEYVA','SUBA','DORADO','CIRCASIA','SALENTO','FILANDIA']; keys.forEach(k=>{ if(t.includes(k)) set.add(k); }); return set; }
  const anchors=[]; state.itinerario.forEach(it=>anchors.push({date:it[0],tokens:tokens(it[2]+' '+it[3])})); (state.stays||[]).forEach(st=>{ anchors.push({date:st.desde,tokens:tokens(st.lugar)}); anchors.push({date:st.hasta,tokens:tokens(st.lugar)}); });
  function catTokens(cat){ if(cat==='TRN_BTA') return new Set(['BOG','SUBA','DORADO']); if(cat==='TRN_MDE') return new Set(['MDE','JMC']); if(cat==='TRN_AXM') return new Set(['AXM']); if(cat==='STY_MDE') return new Set(['MDE']); if(cat==='STY_AXM') return new Set(['AXM','CIRCASIA']); if(cat==='ROAD_ES') return new Set(['MAD','LGR']); return new Set(); }
  function score(a,b){ let s=0; a.forEach(t=>{ if(b.has(t)) s++; }); return s; }
  function inferDate(item){
    const itoks=tokens(item.det); const ct=catTokens(item.cat); ct.forEach(x=>itoks.add(x));
    if(item.cat==='STY_MDE'){ const st=state.stays.find(s=>/MDE|MEDELL/i.test(s.lugar)); if(st) return st.desde; }
    if(item.cat==='STY_AXM'){ const st=state.stays.find(s=>/CIRCASIA|AXM|ARMENIA/i.test(s.lugar)); if(st) return st.desde; }
    if(item.cat==='ROAD_ES'){ if(/Parking/i.test(item.det)||/Gasolina/i.test(item.det)) return '26/09/2025'; }
    if(/BOG.*MDE|Jetsmart/i.test(item.det)) return '02/10/2025';
    if(/MDE.*AXM|Avianca/i.test(item.det)) return '06/10/2025';
    if(/AXM.*BOG|Wingo/i.test(item.det)) return '11/10/2025';
    if(/Villa.*Leyva/i.test(item.det)) return '28/09/2025';
    let best='31/12/2099', bestS=-1; anchors.forEach(a=>{ if(!a.date) return; const s=score(itoks,a.tokens); if(s>bestS || (s===bestS && d2n(a.date)<d2n(best))) { bestS=s; best=a.date; } }); return best;
  }
  state.detalle.sort((a,b)=>{ const da=inferDate(a), db=inferDate(b); const na=da.split('/').reverse().join('-'); const nb=db.split('/').reverse().join('-'); if(na!==nb) return na<nb?-1:1; return (a.det||'').localeCompare(b.det||''); });
}

// ---------- Reset / Demo ----------
function resetData(){ state=clone(SAMPLE); saveState(); render(); }
function recoverData(){ localStorage.removeItem(KEY); state=clone(SAMPLE); render(); }

// ---------- Init ----------
render();
</script>
</body>
</html>
