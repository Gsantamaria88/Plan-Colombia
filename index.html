<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan de Viaje Colombia — Presupuesto & Itinerario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;--card:#121830;--muted:#8590a6;--text:#e5e7eb;--text-soft:#cbd5e1;
      --primary:#10b981;--accent:#60a5fa;--ring:#1f2937;--border:#1f2a44;--chip:#0b1224;
      --table-row:#0b1224;--shadow:rgba(0,0,0,.25);
      --ok:#065f46;--warn:#92400e;--err:#7f1d1d;
    }
    [data-theme="light"]{
      --bg:#f6f7fb;--card:#ffffff;--muted:#5b6476;--text:#0b1020;--text-soft:#334155;
      --primary:#059669;--accent:#2563eb;--ring:#e2e8f0;--border:#e5e7eb;--chip:#eef2ff;
      --table-row:#f8fafc;--shadow:rgba(2,6,23,.08);
      --ok:#d1fae5;--warn:#fef3c7;--err:#fee2e2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;gap:16px}
    .cards{grid-template-columns:1fr}
    @media(min-width:960px){.cards{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px var(--shadow)}
    h1{font-size:20px;margin:0 0 10px 0}
    h2{font-size:16px;margin:0 0 10px 0;color:var(--text-soft)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:8px 12px;color:var(--muted)}
    label{font-size:12px;color:var(--muted)}
    input[type="number"],input[type="text"],select{background:var(--chip);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
    input[type="number"]:focus,input[type="text"]:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    button{background:#111827;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 14px;cursor:pointer}
    [data-theme="light"] button{background:#f1f5f9}
    button.primary{background:linear-gradient(135deg,var(--primary),#22d3ee);border:none;color:#0b1020;font-weight:700}
    button.warn{background:#1f2937;border-color:#374151;color:#fef3c7}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px}
    thead th{font-size:12px;color:var(--muted);border-bottom:1px solid var(--border)}
    tbody tr{background:var(--table-row);border:1px solid var(--border)}
    tbody td{border-top:1px solid rgba(255,255,255,.02)}
    tfoot td{border-top:1px solid var(--border);color:var(--text-soft);font-weight:700}
    .right{text-align:right}
    .note{font-size:12px;color:var(--muted)}
    canvas{width:100% !important;height:auto !important;background:var(--table-row);border:1px solid var(--border);border-radius:16px;padding:8px}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px}
    .switch{position:relative;display:inline-block;width:52px;height:28px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#334155;transition:.3s;border-radius:999px;border:1px solid var(--border)}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;top:2px;background:white;transition:.3s;border-radius:50%}
    input:checked + .slider{background:#16a34a}
    input:checked + .slider:before{transform:translateX(24px)}
    /* Legibilidad y compactación */
    td input[type="text"]{min-width:120px;max-width:100%;width:100%}
    .wrap{white-space:normal;word-break:break-word}
    .ellipsis{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .compact td:first-child,.compact td:nth-child(2){max-width:220px}
    @media (max-width:600px){.compact td:first-child,.compact td:nth-child(2){max-width:140px}}
    .status{border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h1>Plan de Viaje — Colombia · Presupuesto & Itinerario</h1>
      <div class="row" style="gap:12px">
        <span id="testStatus" class="status chip">Cargando…</span>
        <label for="themeToggle" class="note">Tema claro/oscuro</label>
        <label class="switch"><input id="themeToggle" type="checkbox"><span class="slider"></span></label>
      </div>
    </div>
    <div class="row" style="gap:12px;margin:6px 0 16px">
      <span class="chip">Editable · Offline (localStorage)</span>
      <span class="chip">Filtros + Charts dinámicos</span>
      <span class="chip">Exportar / Importar</span>
    </div>

    <div class="grid cards">
      <!-- Card: Gráficos + FX -->
      <section class="card">
        <div class="section-title">
          <h2>Gráficos (gastos en € por categoría)</h2>
          <div class="row">
            <label for="fx" class="note">Tipo de cambio EUR→COP</label>
            <input id="fx" type="number" step="0.01" value="4678.18" style="width:140px" />
            <button class="primary" onclick="saveFX()">Actualizar</button>
          </div>
        </div>
        <canvas id="barChart"></canvas>
        <div style="height:12px"></div>
        <canvas id="pieChart"></canvas>
        <p class="note">Los gráficos usan importes en euros. Las tablas muestran € y COP (según el tipo de cambio editable).</p>
      </section>

      <!-- Card: Presupuesto Detallado -->
      <section class="card" id="card-presupuesto">
        <div class="section-title">
          <h2>Presupuesto detallado</h2>
          <div class="row">
            <select id="filterCat" onchange="applyFilter()">
              <option value="">Todas las categorías</option>
            </select>
            <input id="filterText" type="text" placeholder="Filtrar por texto…" oninput="applyFilter()" />
            <label class="note"><input id="compactToggle" type="checkbox" onchange="toggleCompact()"> Compactar texto</label>
            <button onclick="addRow()">+ Añadir</button>
            <button class="warn" onclick="resetData()">Restablecer</button>
            <button onclick="exportJSON()">Exportar JSON</button>
            <button onclick="downloadCSV('presupuesto.csv', toCSV(state.detalle))">Exportar CSV</button>
            <input type="file" id="importFile" accept="application/json" style="display:none" />
            <button onclick="document.getElementById('importFile').click()">Importar</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:160px">Categoría</th>
              <th>Detalle</th>
              <th class="right">€</th>
              <th class="right">COP</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-detalle" class="wrap"></tbody>
          <tfoot>
            <tr>
              <td></td>
              <td class="right">TOTAL</td>
              <td class="right" id="total-eur">0</td>
              <td class="right" id="total-cop">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </section>

      <!-- Card: Itinerario -->
      <section class="card">
        <div class="section-title">
          <h2>Itinerario (costos por día)</h2>
          <div class="row">
            <input id="filterIt" type="text" placeholder="Filtrar por lugar/actividad…" oninput="applyFilter()" />
            <button onclick="addItRow()">+ Añadir día</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:120px">Fecha</th>
              <th style="width:200px">Lugar</th>
              <th>Actividad</th>
              <th class="right">Costo €</th>
              <th class="right">Costo COP</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-it" class="wrap"></tbody>
          <tfoot>
            <tr>
              <td></td>
              <td></td>
              <td class="right">TOTAL</td>
              <td class="right" id="tot-it-eur">0</td>
              <td class="right" id="tot-it-cop">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </section>
    </div>
  </div>

<script>
// ---------- Estado inicial ----------
const SAMPLE = {
  fx: 4678.18,
  detalle: [
    {cat:"Vuelos", det:"Jetsmart Bogotá → Medellín (3 pax con equipaje)", eur:120},
    {cat:"Vuelos", det:"Avianca Medellín → Armenia (3 pax con equipaje)", eur:140},
    {cat:"Vuelos", det:"Wingo Armenia → Bogotá (3 pax con equipaje)", eur:130},
    {cat:"Transporte Bogotá", det:"Uber Suba → Aeropuerto (ida y vuelta)", eur:20},
    {cat:"Transporte Medellín", det:"Uber Aeropuerto JMC → Medellín (ida)", eur:21},
    {cat:"Transporte Medellín", det:"Uber Medellín → Aeropuerto JMC (vuelta)", eur:21},
    {cat:"Transporte Armenia", det:"Traslados locales Armenia/Quindío (misceláneos)", eur:18},
    {cat:"Alquiler coche Armenia", det:"Alquiler Kia Picanto (5 días)", eur:180},
    {cat:"Alquiler coche Armenia", det:"Seguro adicional (estimado)", eur:50},
    {cat:"Alquiler coche Armenia", det:"Gasolina + peajes (5 días)", eur:40},
    {cat:"Estadía Medellín", det:"Apartamento Medellín (4 noches)", eur:226},
    {cat:"Estadía Armenia", det:"Casa Circasia (5 noches)", eur:160},
    {cat:"Tours Medellín", det:"Free tour Comuna 13 (propina 10 €/pax x3)", eur:30},
    {cat:"Tours Medellín", det:"Tour Guatapé (30 €/pax x3)", eur:90},
    {cat:"Tours Eje Cafetero", det:"Entrada Parque del Café (26 €/pax x3)", eur:78},
    {cat:"Tours Eje Cafetero", det:"Entrada Valle del Cocora (4 €/pax x3)", eur:12},
    {cat:"Tours Eje Cafetero", det:"Entrada Termales Santa Rosa (10 €/pax x3)", eur:30},
    {cat:"Extra", det:"Bogotá → Villa de Leyva (bus 9 €/pax x3)", eur:27},
  ],
  itinerario: [
    ["28/09/2025","Bogotá → Villa de Leyva","Bus a Villa de Leyva (3 pax)",27],
    ["02/10/2025","Bogotá → Medellín","Vuelo Jetsmart + Ubers + Noche Medellín",177],
    ["03/10/2025","Medellín","Free Tour Comuna 13 + Noche Medellín",86],
    ["04/10/2025","Medellín","Tour Guatapé + Noche Medellín",146],
    ["05/10/2025","Medellín","Pueblito Paisa + Metro/Metrocable + Noche Medellín",56],
    ["06/10/2025","Medellín → Armenia","Vuelo Avianca + Uber + Noche Circasia + Seguro coche",243],
    ["07/10/2025","Circasia/Quindío","Valle del Cocora + Salento + coche",106],
    ["08/10/2025","Circasia/Quindío","Parque del Café + coche + Noche Circasia",154],
    ["09/10/2025","Circasia/Quindío","Filandia + Termales + coche + Noche Circasia",106],
    ["10/10/2025","Circasia/Quindío","Día libre + coche + Noche Circasia",76],
    ["11/10/2025","Armenia → Bogotá","Coche + Gasolina + Vuelo Wingo + Uber",184],
  ]
};

let state = loadState();

function loadState(){
  const raw = localStorage.getItem('colombia-plan');
  const s = raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(SAMPLE));
  const pref = localStorage.getItem('theme-pref');
  if(pref) document.documentElement.setAttribute('data-theme', pref);
  return s;
}
function saveState(){ localStorage.setItem('colombia-plan', JSON.stringify(state)); }

// ---------- Tema claro/oscuro ----------
const themeToggle = () => {
  const current = document.documentElement.getAttribute('data-theme')||'dark';
  const next = current==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme-pref', next);
  document.getElementById('themeToggle').checked = next==='light';
};

// ---------- Tipo de cambio ----------
function saveFX(){
  const v = parseFloat(document.getElementById('fx').value||'0');
  state.fx = isFinite(v) && v>0 ? v : state.fx; 
  document.getElementById('fx').value = state.fx.toFixed(2);
  saveState();
  renderTotals();
  renderItTotals();
}

// ---------- Presupuesto Detallado ----------
function addRow(){ state.detalle.push({cat:"Nueva categoría", det:"Descripción", eur:0}); saveState(); render(); }
function delRow(idx){ state.detalle.splice(idx,1); saveState(); render(); }
function onEditRow(idx, field, value){
  if(field==='eur') state.detalle[idx].eur = num(value);
  else state.detalle[idx][field] = value;
  saveState(); renderTotals(); renderCharts(); fillCatFilter();
}

// ---------- Itinerario ----------
function addItRow(){ state.itinerario.push(["", "", "", 0]); saveState(); render(); }
function delItRow(i){ state.itinerario.splice(i,1); saveState(); render(); }
function onEditIt(i, j, value){
  if(j===3) state.itinerario[i][j] = num(value); else state.itinerario[i][j] = value;
  saveState(); renderItTotals();
}

// ---------- Filtros ----------
function applyFilter(){ renderTables(); renderCharts(); }
function toggleCompact(){
  const on = document.getElementById('compactToggle').checked;
  document.getElementById('tbody-detalle').classList.toggle('ellipsis', on);
  document.getElementById('tbody-it').classList.toggle('ellipsis', on);
  document.getElementById('card-presupuesto').classList.toggle('compact', on);
}

// ---------- Utilidades ----------
function num(v){ const n = parseFloat(v||'0'); return isFinite(n)? n:0; }
function fmtEUR(n){return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(n||0)}
function fmtCOP(n){return new Intl.NumberFormat('es-CO').format(Math.round(n||0)) + ' COP'}

// ---------- Render ----------
function render(){
  try{
    // Initialize theme toggle
    const pref = document.documentElement.getAttribute('data-theme');
    document.getElementById('themeToggle').checked = (pref==='light');
    document.getElementById('themeToggle').onclick = themeToggle;

    document.getElementById('fx').value = state.fx.toFixed(2);
    fillCatFilter();
    renderTables();
    renderTotals();
    renderItTotals();
    renderCharts();
  } catch(err){
    setStatus('err', 'Render error: '+err.message);
  }
}

function fillCatFilter(){
  const sel = document.getElementById('filterCat');
  const keep = sel.value;
  const cats = [...new Set(state.detalle.map(r=>r.cat||'Otros'))].sort();
  sel.innerHTML = '<option value="">Todas las categorías</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  sel.value = keep || '';
}

function renderTables(){
  const txt = (document.getElementById('filterText').value||'').toLowerCase();
  const cat = document.getElementById('filterCat').value||'';

  // Detalle
  const tb = document.getElementById('tbody-detalle');
  tb.innerHTML = '';
  state.detalle
    .filter(r => (!cat || r.cat===cat) && (!txt || (r.cat+" "+r.det).toLowerCase().includes(txt)))
    .forEach((r,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td title="${r.cat}"><input type="text" value="${r.cat}" oninput="onEditRow(${idx},'cat',this.value)"/></td>
        <td title="${r.det}"><input type="text" value="${r.det}" oninput="onEditRow(${idx},'det',this.value)"/></td>
        <td class="right"><input type="number" step="0.01" value="${r.eur}" oninput="onEditRow(${idx},'eur',this.value)"/></td>
        <td class="right">${fmtCOP(r.eur*state.fx)}</td>
        <td class="right"><button onclick="delRow(${idx})">Eliminar</button></td>`;
      tb.appendChild(tr);
    });

  // Itinerario
  const ft = (document.getElementById('filterIt').value||'').toLowerCase();
  const tbi = document.getElementById('tbody-it');
  tbi.innerHTML='';
  state.itinerario
    .filter(it => (!ft || (it[1]+" "+it[2]).toLowerCase().includes(ft)))
    .forEach((it, i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td title="${it[0]}"><input type="text" value="${it[0]}" oninput="onEditIt(${i},0,this.value)"/></td>
        <td title="${it[1]}"><input type="text" value="${it[1]}" oninput="onEditIt(${i},1,this.value)"/></td>
        <td title="${it[2]}"><input type="text" value="${it[2]}" oninput="onEditIt(${i},2,this.value)"/></td>
        <td class="right"><input type="number" step="0.01" value="${it[3]}" oninput="onEditIt(${i},3,this.value)"/></td>
        <td class="right">${fmtCOP(it[3]*state.fx)}</td>
        <td class="right"><button onclick="delItRow(${i})">Eliminar</button></td>`;
      tbi.appendChild(tr);
    });
}

function renderTotals(){
  const totalE = state.detalle.reduce((a,b)=>a+(+b.eur||0),0);
  const totalC = totalE * state.fx;
  document.getElementById('total-eur').textContent = fmtEUR(totalE);
  document.getElementById('total-cop').textContent = fmtCOP(totalC);
}
function renderItTotals(){
  const tE = state.itinerario.reduce((a,b)=>a+(+b[3]||0),0);
  const tC = tE * state.fx;
  document.getElementById('tot-it-eur').textContent = fmtEUR(tE);
  document.getElementById('tot-it-cop').textContent = fmtCOP(tC);
}

// ---------- Charts ----------
let barChart, pieChart;
function groupByCategory(){
  const map = new Map();
  // mismo filtro que la tabla
  const txt = (document.getElementById('filterText').value||'').toLowerCase();
  const cat = document.getElementById('filterCat').value||'';
  state.detalle
    .filter(r => (!cat || r.cat===cat) && (!txt || (r.cat+" "+r.det).toLowerCase().includes(txt)))
    .forEach(r=>{
      const k = r.cat||'Otros';
      map.set(k, (map.get(k)||0) + (+r.eur||0));
    });
  return {labels:[...map.keys()], values:[...map.values()]};
}
function renderCharts(){
  const {labels, values} = groupByCategory();
  const ctx1 = document.getElementById('barChart');
  const ctx2 = document.getElementById('pieChart');
  const colors = ['#34d399','#60a5fa','#fbbf24','#f472b6','#a78bfa','#22d3ee','#f59e0b','#10b981','#ef4444','#93c5fd'];

  if(barChart) barChart.destroy();
  barChart = new Chart(ctx1, {
    type:'bar',
    data:{labels, datasets:[{label:'Gasto (€)', data:values, backgroundColor:labels.map((_,i)=>colors[i%colors.length])}]},
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label: (c)=>`€ ${c.parsed.y.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})}`}},
      },
      scales:{
        y:{beginAtZero:true, ticks:{color:'var(--text-soft)'}, grid:{color:'var(--border)'}},
        x:{ticks:{color:'var(--text-soft)'}, grid:{display:false}}
      }
    }
  });

  if(pieChart) pieChart.destroy();
  pieChart = new Chart(ctx2, {
    type:'pie',
    data:{labels, datasets:[{data:values, backgroundColor:labels.map((_,i)=>colors[i%colors.length])}]},
    options:{responsive:true, plugins:{legend:{position:'bottom'}}}
  });
}

// ---------- Export / Import ----------
function exportJSON(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'colombia-plan.json';
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
function toCSV(rows){
  const header = ['Categoría','Detalle','Euros','COP'];
  const fx = state.fx;
  const esc = (s)=>String(s).replace(/"/g,'""');
  const data = rows.map(r=>[r.cat, r.det, r.eur, Math.round(r.eur*fx)]);
  return [header, ...data]
    .map(r=>r.map(x=>`"${esc(x)}"`).join(','))
    .join('\n');
}
function downloadCSV(filename, content){
  const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

document.getElementById('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{ state = JSON.parse(reader.result); saveState(); render(); setStatus('ok','Importado correctamente'); }
    catch(err){ alert('Archivo inválido'); setStatus('err','Import falló: '+err.message); }
  };
  reader.readAsText(f);
});

function resetData(){
  if(confirm('¿Restablecer al ejemplo inicial?')){
    state = JSON.parse(JSON.stringify(SAMPLE));
    saveState(); render(); setStatus('warn','Restablecido al ejemplo');
  }
}

// ---------- Self-tests (pruebas rápidas) ----------
function setStatus(kind, msg){
  const el = document.getElementById('testStatus');
  if(!el) return;
  el.textContent = msg;
}
function runSelfTests(){
  try{
    // Test 1: funciones presentes
    if(typeof exportJSON !== 'function') throw new Error('exportJSON no está definida');
    if(typeof toCSV !== 'function') throw new Error('toCSV no está definida');

    // Test 2: CSV tiene salto de línea correcto y encabezado
    const csv = toCSV([{cat:'X',det:'Y',eur:1}]);
    if(!csv.includes('\n')) throw new Error('CSV no contiene saltos de línea \\n');
    if(!csv.startsWith('"Categoría","Detalle","Euros","COP"')) throw new Error('CSV sin encabezado');

    // Test 3: Agrupación por categoría coherente
    const g = groupByCategory();
    if(!Array.isArray(g.labels) || !Array.isArray(g.values)) throw new Error('groupByCategory mal formado');

    setStatus('ok','Tests OK');
  } catch(err){
    setStatus('err','Tests fallaron: '+err.message);
    console.error(err);
  }
}

// ---------- Init ----------
render();
runSelfTests();
</script>
</body>
</html>
